# py_recommender/recommender.pyx
# python: boundscheck=False
# python: wraparound=False
import numpy as np
cimport numpy as np
cimport cython
from libc.math cimport sqrt

@python.boundscheck(False)
@python.wraparound(False)
def cosine_similarity_matrix(np.ndarray[np.float64_t, ndim=2] mat):
    cdef Py_ssize_t n_items = mat.shape[0]
    cdef Py_ssize_t dim = mat.shape[1]
    cdef np.ndarray[np.float64_t, ndim=2] out = np.zeros((n_items, n_items), dtype=np.float64)
    cdef Py_ssize_t i, j, k
    cdef double dot, ni, nj, v
    cdef double tmpi

    cdef np.ndarray[np.float64_t, ndim=1] norms = np.zeros(n_items, dtype=np.float64)
    for i in range(n_items):
        tmpi = 0.0
        for k in range(dim):
            v = mat[i, k]
            tmpi += v * v
        norms[i] = sqrt(tmpi) if tmpi > 0.0 else 1.0

    for i in range(n_items):
        out[i, i] = 1.0
        for j in range(i+1, n_items):
            dot = 0.0
            for k in range(dim):
                dot += mat[i, k] * mat[j, k]
            ni = norms[i]
            nj = norms[j]
            if ni == 0.0 or nj == 0.0:
                out[i, j] = 0.0
            else:
                out[i, j] = dot / (ni * nj)
            out[j, i] = out[i, j]
    return out
